#summary Tunnelblick VPN Configurations
#sidebar wSb
<wiki:toc max_depth="2" />

==Introduction==
A Tunnelblick VPN Configuration (a "Configuration") is a folder with an extension of .tblk that contains information about one VPN configuration.
  * Configurations provide a convenient way to distribute VPN configurations separate from the Tunnelblick application itself.
  * Configurations may be installed to be shared by all users of the computer, or installed to be private to a single user.
  * Configurations may be automatically installed when Tunnelblick is installed by including them in the Tunnelblick disk image.
  * Configurations may be set up to connect when the computer starts, and persist through logins and logouts.
  * Configurations may contain identification and version information to assist in version control.
  * Installing a Configuration "secures" it by setting ownership and permissions on its contents.
  * Installing a Configuration requires a computer administrator username/password (as does Tunnelblick installation).
  * The configuration file in a Configuration installed as private will be "shadow copied" to the boot drive if it is on a network volume or if the "Use Shadow Copies" preference is set.

Tunnelblick Configurations must be installed before they can be used.

The configuration file of a Configuration that is private may be edited. The configuration file of a Configuration that is shared may only be examined.

==Creation==
You can create a Configuration by collecting together the configuration file and any files associated with the configuration into a folder. Give the folder the name you wish to appear in Tunnelblick's list of configurations, and add an extension of ".tblk". You do not need to arrange the files in the folder in any way -- the installation process will copy each file to its appropriate place. The name of the files within the folder do not matter, except for the optional Info.plist file (see [wPkgs#Format Format], below).

Example: a folder named "Main Office.tblk" is a Tunnelblick VPN Configuration that will show up in Tunnelblick as the "Main Office" configuration.

==Installation==
_Note: a Configuration cannot be installed using "shadow copies". If the Configuration cannot be secured (e.g., it is on a network volume, thumb or other external drive, or other non-securable media) an error message will be displayed during installation._

Installation of a Configuration can be done manually by double-clicking it or by dragging it to a Tunnelblick icon in Finder. (A Configuration _cannot_ be dragged to the Tunnelblick icon in the Status Bar.) Installation can also be done automatically when Tunnelblick is installed from a disk image or certain other other volumes (see [wPkgs#Automatic_Installation Automatic Installation]).

When a Configuration is installed, it's contents are copied and the copy is secured by setting ownership and permissions on the copy's contents.

An installed Configuration may be shared or private. Configurations to be shared are copied to `/Library/Application Support/Tunnelblick/Shared`, and Configurations to be kept private are copied to `~/Library/Application Support/Tunnelblick/Configurations`.

==Format==
Tunnelblick Configurations are folders with an extension of ".tblk". (OS X will treat the folder as a Configuration because of the extension.)

The contents of a Tunnelblick VPN Configuration are arranged as follows after installation (they need not be arranged this way prior to installation, and the configuration file may have any name before installation):

{{{
    sample.tblk/
        Contents/
            (Optional) Info.plist
            Resources/
                config.ovpn, containing OpenVPN configuration information
                (Optional) shell scripts: up.tunnelblick.sh, down.tunnelblick.sh
                (Optional) shell scripts: pre-connect.sh, post-disconnect.sh
                (Optional, deprecated shell scripts) up.sh, down.sh, nomonitor.up.sh, and/or nomonitor.down.sh
                (Optional) key, certificate, and/or other shell script files
}}}
The name of the Configuration (without ".tblk") is used as the display name of the configuration unless it conflicts with an existing name (see [wPkgs#Name_Conflicts_During_Installation Name Conflicts During Installation]).

==File References in the OpenVPN Configuration File==
Within the OpenVPN configuration file itself, refer to other files, such as key or certificate files, without using a path or path prefix -- just use the name of the file.

Example: Refer to the "xyz.key" file in the OpenVPN configuration file as "key xyz.key", not "key abc/xyz.key".

==Info.plist==
Info.plist is optional. If it exists, it must be an OS X property list file, and may contain the following keys:
||Key||Description||Default||Examples||
||CFBundleIdentifier||A string that uniquely identifies the configuration and the individual or organization distributing the Configuration.||(None)||com.example.tbconfigs.config27A||
||CFBundleVersion ||A string representing the version number that is used to determine later/earlier versions of the Configuration (see [wPkgs#CFBundleIdentifier_Conflicts CFBundleIdentifier Conflicts]). The string must consist of a major version number, optionally followed by a decimal point and a minor version number, optionally followed by a decimal point and a bugfix version number||(None)||1.16.4||
||CFBundleShortVersionString||A string to display as the version (in Get Info, for example)||(None)||1.6 Test 3||
||TBPackageVersion||A string with the Configuration version number||1||The string "1" (without the quotation marks)||
||TBInstallWhenInstallingTunnelblick||A string specifying whether to install the Configuration when the Configuration is located on a disk image or other volume from which Tunnelblick cannot be used and Tunnelblick is installed by double-clicking Tunnelblick.app on the volume. Configurations will be found if they are in the same folder as Tunnelblick.app or any subfolder of that folder, including invisible subfolders. Must be "yes", "no", or "ask" (without the quotation marks)||ask||no||
||TBReplaceIdentical||A string specifying whether to install the Configuration over a Configuration with the same CFBundleIdentifier. Must be "yes", "no", "ask", or "force" (without the quotation marks)||ask||yes||
||TBSharePackage||A string specifying whether to install the Configuration as shared or private, or to ask the user. Must be "shared", "private", or "ask" (without the quotation marks)||ask||ask||
||TBPreference||See [wPkgs#Preferences Preferences]|| ||TBPreferenceuseDNS||

==Preferences==
A Configuration's Info.plist may also optionally contain entries (strings, numbers, and booleans) with keys that start with "TBPreference". The entries are preferences for the configuration. If not already present (with any value), each entry will be copied to the user's regular preferences each time Tunnelblick loads the Configuration (when Tunnelblick is launched or the Configuration is installed). When the entries are copied, "TBPreference" is replaced with the display name of the Configuration. Note that the "autoConnect" option triggers a connection when Tunnelblick is started, so a configuration with "TBPreferenceautoConnect" is not connected automatically when it is installed, but is connected automatically the next time Tunnelblick is launched.

In a Deployed version of Tunnelblick, the forced-preferences in Deploy will override any Configuration-specified preferences. 

==Up and Down Scripts==
If the Configuration contains up.tunnelblick.sh, down.tunnelblick.sh, up.sh, down.sh, nomonitor.up.sh, and/or nomonitor.down.sh, those shell scripts will be used instead of Tunnelblick's standard scripts, or scripts in Deploy, when connecting with the Configuration and "Set nameserver" is checked for the Configuration's configuration.

For backward compatibility, scripts other than up.tunnelblick.sh and down.tunnelblick.sh will be used if they exist.

In a Deployed version of Tunnelblick, a Configuration's up/down scripts will override the corresponding scripts in Deploy.

==Pre-Connect and Post-Disconnect Scripts==
If the Configuration includes "pre-connect.sh" and "post-disconnect.sh" scripts, they will be executed (as root) before connecting and/or after disconnecting. This allows manipulation of kexts and/or the network configuration before the tun/tap kexts are loaded and OpenVPN is run and after OpenVPN exits and the kexts are unloaded. (If the scripts load special kexts, you can use the "-doNotLoadTapKext" and "-doNotLoadTunKext" preferences to cause Tunnelblick to not try to load its own kexts.)

==Automatic Installation==
When Tunnelblick itself is installed (by double-clicking Tunnelblick.app when it is located on a disk image or other volume from which it cannot be used), all Configurations in the folder containing the Tunnelblick.app being installed, or a subfolder of it, that have "TBInstallWhenInstallingTunnelblick" set to "yes" are installed (subject to [wPkgs#CFBundleIdentifier_Conflicts CFBundleIdentifier Conflicts] and [wPkgs#Name_Conflicts_During_Installation Name Conflicts During Installation]. If a Configuration's "TBInstallWhenInstallingTunnelblick" is set to "no", the Configuration will not be installed. If "TBInstallWhenInstallingTunnelblick" is "ask", the user will be asked before installing the Configuration.

== CFBundleIdentifier Conflicts==
On automatic or manual installation of a Configuration, if a Configuration with an identical CFBundleIdentifier is already installed:
  * If the new Configuration's "TBReplaceIdentical" is "no", the Configuration will not be installed.
  * If the new Configuration's "TBReplaceIdentical" is "yes", the existing Configuration will be replaced without notifying the user if it has an equal or higher "CFBundleVersion" than the existing installed Configuration. If it has a lower "CFBundleVersion", the Configuration will not be installed.
  * If the new Configuration's "TBReplaceIdentical" is "force", the existing Configuration will be replaced without notifying the user.
  * If the new Configuration's "TBReplaceIdentical" is "ask", the existing Configuration will be replaced only after getting the user's consent.

When an existing Configuration is replaced, the new copy takes the display name of the existing version, regardless of the name of the new Configuration. Thus, the new version will inherit the existing version's preferences and Keychain items.

==Name Conflicts During Installation==
If the display name of a Configuration is the same as the name of an existing .ovpn or .conf file or  an existing Configuration that has a different CFBundleIdentifier, the user will be asked to rename the Configuration or cancel the installation.

==Name Conflicts After Installation==
Configurations are displayed from
  * `Tunnelblick.app/Contents/Resources/Deploy`
  * `/Library/Application Support/Tunnelblick/Shared/*.tblk`
  * `/Library/Application Support/Tunnelblick/Shared/*.ovpn and *.conf`
  * `~/Library/Application Support/Tunnelblick/Configurations/*.tblk``
  * `~/Library/Application Support/Tunnelblick/Configurations/*.ovpn and *.conf`
in that order. If a display name matches an earlier display name, the later configuration will be ignored and only the earlier display name will be displayed, making only the earlier configuration available.

------------------

===PLEASE USE THE [http://groups.google.com/group/tunnelblick-discuss TUNNELBLICK DISCUSSION GROUP] FOR COMMENTS OR QUESTIONS*===