#summary Deploying Tunnelblick
#labels Phase-Deploy,Featured

http://groups.google.com/group/tunnelblick-discuss/web/tb-logo.png

This document describes how to create a deployable version of Tunnelblick and was last modified 2009-10-29.

Tunnelblick is an OS X Graphical User Interface (GUI) for the OpenVPN free and open-source program, which maintains VPN "tunnels". It provides easy-to-use control of OpenVPN server and/or client connections. It is written in Cocoa, runs on OS X Tiger (10.4), Leopard (10.5), and Snow Leopard (10.6) when booted into 32-bit mode. It comes as a ready to use Universal 32-bit application with all necessary binaries and drivers, including OpenVPN and tun/tap. Tunnelblick is free software licensed under the GNU General Public License (GPL) Version 2.

For more information, including wikis and a discussion group, see the [http://code.google.com/p/tunnelblick/ Tunnelblick home page].

*This document may be obsolete!* The latest versions of this document and related documents including release notes, FAQ, and instructions 
for using and building Tunnelblick from the source code may be found in the [http://code.google.com/p/tunnelblick/w/list Tunnelblick Wiki].

This document contains the following sections:

<wiki:toc max_depth="2" />

==WHAT IS A DEPLOYABLE VERSION?==
A deployable version of Tunnelblick is a Tunnelblick.app which includes everything necessary to install and run Tunnelblick and connect to one or more VPNs. In particular, it includes one or more OpenVPN configuration files, and, usually, certificate and key files for authentication. It can also include shell scripts and text that will appear in Tunnelblick's "about" window, and can specify user preferences that are forced to particular values and are read-only.

==HOW IT WORKS==
  * Each time Tunnelblick starts:
    # If there is no Tunnelblick.app/Contents/Resources/Deploy folder, and there is a backup folder for it, and the user agrees, the Deploy folder is restored from the backup
    # "root" is made the owner of everything in Tunnelblick.app, including the Deploy folder and its contents
    # The permissions of most items within Tunnelblick.app is set to "644" (root can read/write, everyone else can read), except
      * The permissions of the standard up/down scripts, leasewatch, and openvpn are set to 744
      * The permissions of installer and openvpnstart are set to 4111
      * The permissions of the following files in Deploy are given different permissions:
        * .crt and .key files are given permissions of "600" (root can read/write, nobody else can read)
        * .sh files are given permissions of "744" (root can read/write/execute, everyone else can read)
    # If the Deploy folder exists (or has just been restored), a new backup of it is made. The backup is owned by root and has the same permissions as the original items in Deploy (as modified in 3, above).
  * If there is a Deploy folder and it contains one or more .conf or .ovpn files, Tunnelblick uses it, instead of ~/Library/openvpn, for configuration files (and, often, keys, certificates, and shell scripts, but whether the same folder is used for them depends on what is in the configuration file). The first line of the OpenVPN Log will contain the note "configuration from Deploy" if this is being done.
  * If the file Tunnelblick.app/Contents/Resources/about.html exists, its contents will replace the link to "http://code.google.com/p/tunnelblick" in Tunnelblick's "about" window. The content of about.html will be prefixed by `'<html><body><center><div style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px">'`, and followed by `'<br><br>Based on Tunnelblick, free software available at <a href=\"http://code.google.com/p/tunnelblick\">http://code.google.com/p/tunnelblick</a></div></center><body></html>'`. Note that there is only space for a couple of lines of text.
  * If the Deploy folder is being used and the file Tunnelblick.app/Contents/Resources/Deploy/forced-preferences.plist exists, the preferences contained in it override any preferences the user has set. Since this file is read-only, the user cannot change these preferences, and corresponding preferences in in Tunnelblick's preferences stored in ~/Library/Preferences will be ignored. Also see "FORCED PREFERENCES EXCEPTIONS".

Backups of the Deploy folder are created in /Libary/Tunnelblick/Backup/A/B/C/D/E.../TunnelblickBackup, where "/A/B/C/D/E..." is the absolute path to Tunnelbick.app itself. For example, if Tunnelblick.app is located in /Applications, the Deploy backup would be stored in /Library/Tunnelblick/Backup/Applications/TunnelblickBackup. This allows each copy of Tunnelblick on a computer to have its own backup. Up to three backups are kept: the current and previous Deploy, and Deploy at the time Tunnelblick was first run from it's current location.

Note that if Tunnelblick.app is moved, a new backup will be created for the new location the first time Tunnelblick.app is run in the new location. The old backup will continue to exist, however, this is not in itself a security risk because moving Tunnelblick.app (after it is first run and a backup of Deploy has been made) requires authorization by an administrator. It is suggested that any such move be followed by deletion of the backup, which also requires an administrator. Otherwise a fresh copy of Tunnelblick in the old position in the file hierarchy could be used to connect to the VPN because its Deploy folder could be "recovered" from the backup the first time it is run.

==WHAT ABOUT AUTOMATIC UPDATES?==
A version of Tunnelblick with a Deploy folder will work with Tunnelblick's standard automatic update process. The automatic update replaces Tunnelblick.app with a new copy without the Deploy folder; however, when the updated program is first run, the the Deploy folder will be restored from the backup copy, and will then be used normally. Note: "about.html" is not included in standard Tunnelblick updates, so it will be lost when there is an update because it is not located in the Deploy folder.

==FORCED PREFERENCES EXCEPTIONS==
There are two exceptions to the way preferences in "forced-preferences.plist" are treated:
  * All preferences with a key beginning with "SU" are ignored. (This may change in the future for some of these preferences).
  * The _`*`-keychainHasPrivateKey_ and _`*`-keychainHasUsernameAndPassword_ preferences (where "`*`" is the name of a configuration file) -- regardless of value -- prevent the user from storing or using passphrases, usernames, or passwords in the Keychain. Dialog boxes will not include a "Save to Keychain" checkbox, and any passphrases, usernames, and passwords in the Keychain will be ignored. 

==WHAT IS NEEDED TO MAKE A DEPLOYABLE VERSION==
To make a deployable version of Tunnelblick, you need whatever is required to connect to your VPN.

To be more specific specific, you need:
    * A copy of the Tunnelblick .dmg file with Tunnelblick version 3.0b22 or later. The latest version may be downloaded from [http://code.google.com/p/tunnelblick the Tunnelblick website].
    * One or more OpenVPN configuration files, with extensions of ".ovpn" or ".conf".
    * Certificate and key files for authentication.
    * Optional: shell script files, with extension ".sh", if you do not use Tunnelblick's "Set nameserver" feature. If you have shell files, they must have an extension of "sh"; otherwise they will not have execute permissions.
    * Optional: "about.html" file, containing text that will be displayed in Tunnelblick's "about" window.
    * Optional: "forced-preferences.plist" file, containing user preferences that you wish to override.
    * Optional: other files that you want your configuration file or scripts to be able to use.

==HOW TO MAKE A DEPLOYABLE VERSION==
    # Create a new folder on your Desktop and rename it "Deploy"
    # Copy the configuration files, any certificate and key files and shell scripts, and any of the optional files you wish to use, into the "Deploy" folder
    # Open the Tunnelblick .dmg file. A new Finder window will appear with (among other things) Tunnelblick.app
    # Drag Tunnelblick.app to the Desktop (or some other place you will work with it). This is the copy you will modify to create your deployable version.
    # Right-click on Tunnelblick.app, and click "Show Package Contents". A new Finder window will appear with a folder "Contents".
    # Double-click on "Contents". The window will change to show several items. One of them is a folder, "Resources"
    # Command-drag your "Deploy" folder and drop it onto "Resources" to copy the folder into "Resources"
    # If you have one, copy your "about.html" file into "Resources"
    # Close the window that contains "Resources"

That's it! You are done! Tunnelblick.app has your new version of Tunnelblick with a "Deploy" folder containing everything that Tunnelblick needs for connection to your VPN.

However, *DO NOT RUN THIS COPY*. Instead, make a copy of it and use the copy. (When Tunnelblick is first run it makes changes to the ownership and permissions of parts of the application. That makes it inconvenient to copy, move, or modify the application after it has been run without entering administrator credentials, so keep a copy that has never been run.)

==HOW TO *USE* A DEPLOYED VERSION==
Using a deployed version of Tunnelblick is the same as using a non-deployed version, except:
  * You will not be asked for administrator credentials the first time you first connect to a VPN. (Because secure ownership and permissions on the configuration file(s) during the first time the deployed version of Tunnelblick was run on the computer.
  * Anyone with access to a deployed version of Tunnelblick.app can connect to its VPN(s). For example, if a deployed version of Tunnelblick.app is placed in /Applications, it can be accessed by any user of the computer, without requiring administrator credentials to set up secure configuration files in ~/Library/openvpn -- because ~/Library/openvpn is not used.

==CREATING A .ZIP FILE FOR DEPLOYMENT==
To create a .zip file of your new version of Tunnelblick:
    # Right-click on your new version of Tunnelblick, and click "Compress Tunnelblick.app"
That's all. There is no step 2. Your .zip file has been created.

==CREATING A .DMG FILE FOR DEPLOYMENT==
    # Create a new folder on your Desktop and rename it to "Tunnelblick"
    # Copy whatever you want to include in the .dmg file into the folder, including your new version of Tunnelblick.app
    # Open /Applications/Utilities/Disk Utility
    # Chose "File", then "New", then "Disk Image from Folder"
    # Select the folder you set up in steps 1. and 2. and click the "Image" button
    # Type a name for your .dmg file, and select a location in which to store it
    # Select "Image Format: compressed", and "Encryption: none"
    # Click "Save"
Within a few moments, your .dmg file will be created.





